<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>requireJs</title>
</head>
<body>
<script>
	(function(){
		var config={
			alias:{
				'a':'a.js',
				'b':'b.js'
			}
		};
		var factorys=[];
		var modules={};
		var loadings=[];

		window.define=function(id,deps,factory){
			var args=[].slice.call(arguments);
			var _id='',
				_deps=[],
				_factory;
			if(typeof id==='string'){
				_id=args.shift();
			}
			_deps=typeof args[0]=='function'?[]:args.shift();
			_factory=args.shift();
			_id=modules[_id]&&modules[_id].state>=1?_id:getCurrentScript();
			_factory.id=_id;
			_factory.delay=function(){

			};
			factorys.push(_factory);
		};

		window.require=function(list,factory){
			var deps={},
				args=[],
				id='callback'+setTimeout('1'),
				dn=0,
				cn=0,
				url='';
			String(list).replace(/[^\,\s]+/g, function(el) {
				url=config.alias[el]||el;//js路径
				if(!/\w+\.js/.test(url)){//没有后缀
					url+=url.slice(-1)=='.'?'js':'.js';
				}
				if(!modules[url]){
					modules[url]={
						id:url
					};
					loadJS(url);
				}
				dn++;
				if(modules[url]&&modules[url].state==2){
					cn++;
				}
				if(!deps[url]){
					args.push(url);
					deps[url]='jeff';
				}
			});
			modules[id] = {//创建一个对象,记录模块的加载情况与其他信息
	            id: id,
	            factory: factory,
	            deps: deps,
	            args: args,
	            state: 1
	        };
	        if(dn==cn){
	        	fireFactory(id,deps,factory);
	        } else {
	        	loadings.unshift(id);
	        }
		};

		function fireFactory(id, deps, factory) {

		}

		/**
		 * 获取当前文件的路径
		 */
	    function getCurrentScript(base) {
	        // 参考 https://github.com/samyk/jiagra/blob/master/jiagra.js
	        var stack;
	        try {
	            a.b.c(); //强制报错,以便捕获e.stack
	        } catch (e) { //safari的错误对象只有line,sourceId,sourceURL
	            stack = e.stack;
	            if (!stack && window.opera) {
	                //opera 9没有e.stack,但有e.Backtrace,但不能直接取得,需要对e对象转字符串进行抽取
	                stack = (String(e).match(/of linked script \S+/g) || []).join(" ");
	            }
	        }
	        if (stack) {
	            /**e.stack最后一行在所有支持的浏览器大致如下:
	             *chrome23:
	             * at http://113.93.50.63/data.js:4:1
	             *firefox17:
	             *@http://113.93.50.63/query.js:4
	             *opera12:http://www.oldapps.com/opera.php?system=Windows_XP
	             *@http://113.93.50.63/data.js:4
	             *IE10:
	             *  at Global code (http://113.93.50.63/data.js:4:1)
	             *  //firefox4+ 可以用document.currentScript
	             */
	            stack = stack.split(/[@ ]/g).pop(); //取得最后一行,最后一个空格或@之后的部分
	            stack = stack[0] === "(" ? stack.slice(1, -1) : stack.replace(/\s/, ""); //去掉换行符
	            return stack.replace(/(:\d+)?:\d+$/i, ""); //去掉行号与或许存在的出错字符起始位置
	        }
	        var nodes = (base ? document : head).getElementsByTagName("script"); //只在head标签中寻找
	        for (var i = nodes.length, node; node = nodes[--i]; ) {
	            if ((base || node.className === moduleClass) && node.readyState === "interactive") {
	                return node.className = node.src;
	            }
	        }
	    }

	    /**
	     * 加载js
	     * @param    {[type]}                 url      [description]
	     * @param    {Function}               callback [description]
	     */
	    function loadJS(url,callback){
	    	var fn=function(){
	    		var factory = factorys.pop();
                factory && factory.delay(node.src);
                callback && callback();
	    	},
	    	script=document.createElement('script');
	    	script.type="text/javascript";
	    	if(script.readyState){
	    		script.onreadystatechange=function(){
	    			if(/loaded|complete/i.test(script.readyState)){
	    				fn();
	    			}
	    		}
	    	} else {
	    		script.onload=fn;
	    	}

	    	script.src=url;
	    	document.getElementsByTagName("head")[0].appendChild(script);
	    }
	}());
</script>
</body>
</html>